"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _axios=_interopRequireDefault(require("axios")),_aioPopup=_interopRequireDefault(require("aio-popup")),_jquery=_interopRequireDefault(require("jquery"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||"default");if("object"!=typeof s)return s;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}require("./index.css");class AIOApis{constructor(e){_defineProperty(this,"storage",void 0),_defineProperty(this,"request",void 0),_defineProperty(this,"getAppState",void 0),_defineProperty(this,"setStorage",void 0),_defineProperty(this,"getStorage",void 0),_defineProperty(this,"removeStorage",void 0),_defineProperty(this,"setToken",void 0),_defineProperty(this,"getLoading",void 0),_defineProperty(this,"handleLoading",void 0),_defineProperty(this,"responseToResult",void 0),_defineProperty(this,"requestFn",void 0),_defineProperty(this,"addAlert",void 0),_defineProperty(this,"handleCacheVersions",void 0),_defineProperty(this,"showErrorMessage",void 0),_defineProperty(this,"showSuccessMessage",void 0);let{id:t,getAppState:i=()=>{},loader:s,lang:r="en"}=e,o=new Storage(t);this.storage=o,this.getAppState=i,this.setStorage=(e,t)=>o.save(e,t),this.getStorage=(e,t)=>o.load(e,t),this.removeStorage=e=>o.remove(e),this.setToken=t=>{let i=t||e.token;i&&(_axios.default.defaults.headers.common.Authorization=`Bearer ${i}`)},this.addAlert=e=>{let{type:t,text:i,subtext:s,time:r,alertType:o="alert"}=e;"alert"===o?new _aioPopup.default().addAlert({type:t,text:i,subtext:s,time:r,className:"aio-apis-popup"}):new _aioPopup.default().addSnackebar({type:t,text:i,subtext:s,time:r})},this.getLoading=e=>(console.log(`aio-service show loading by ${e}`),`
              <div class="aio-service-loading" id="aio-service-${e}">
                <div class="aio-service-loading-0">
                  <div class="aio-service-loading-1">
                    <div class="aio-service-loading-2" style="animation: 1s ease-in-out 0.0s infinite normal none running aioserviceloading;"></div>
                    <div class="aio-service-loading-2" style="animation: 1s ease-in-out 0.1s infinite normal none running aioserviceloading;"></div>
                    <div class="aio-service-loading-2" style="animation: 1s ease-in-out 0.2s infinite normal none running aioserviceloading;"></div>
                    <div class="aio-service-loading-2" style="animation: 1s ease-in-out 0.3s infinite normal none running aioserviceloading;"></div>
                    <div class="aio-service-loading-2" style="animation: 1s ease-in-out 0.4s infinite normal none running aioserviceloading;"></div>
                  </div>
                </div>
              </div>
            `),this.handleLoading=(e,t,i)=>{let{loading:r=!0,loadingParent:o="body"}=i;if(r){if(e){let a=s?`<div class="aio-service-loading" id="aio-service-${t}">${s()}</div>`:this.getLoading(t);(0,_jquery.default)(o).append(a)}else{let n=(0,_jquery.default)("#aio-service-"+t);n.length||(n=(0,_jquery.default)(".aio-service-loading")),n.remove()}}},this.handleCacheVersions=e=>{let t={};for(let i in e)t[i]=0;let s=this.getStorage("storedCacheVersions",t),r={};for(let o in e)void 0!==s[o]&&(s[o]!==e[o]?(r[o]=!0,this.removeStorage(o)):r[o]=!1);return this.setStorage("storedCacheVersions",e),r},this.showErrorMessage=e=>{let{result:t,message:i,description:s}=e;if(!1===i.error)return;let o;o="string"==typeof i.error?i.error:"fa"===r?`${s} با خطا روبرو شد`:`An error was occured in ${s}`,this.addAlert({type:"error",text:o,subtext:t,time:i.time,alertType:i.type})},this.showSuccessMessage=e=>{let{result:t,message:i,description:s}=e;if(!i.success)return;let o="function"==typeof i.success?i.success(t):i.success;!0===o&&(o=""),this.addAlert({type:"success",text:"fa"===r?`${s} با موفقیت انجام شد`:`${s} was successfull`,subtext:o,time:i.time,alertType:i.type})},this.responseToResult=async t=>{let{url:i,method:s,body:r,getResult:o,config:a={}}=t,{onCatch:n=e.onCatch,getError:d=e.getError}=a;try{let l=await _axios.default[s](i,void 0!==r?r:void 0);if(l){let h=d?d(l,a):void 0;if("string"==typeof h)return h}return o(l)}catch(u){let v=d?d(u.response||u,a):void 0;if(v)return v;let f;try{f=n?n(u,a):void 0}catch(g){f=g.message||g.Message}return f||(f=u.message||u.Message),f}},this.requestFn=async e=>{let{config:t={},parameter:i}=e,s="aa"+Math.round(1e5*Math.random()),{onError:r,onSuccess:o,errorResult:a,cache:n,message:d={},description:l=s,token:h}=t;if(n){let u=this.storage.load(n.name,void 0,n.time);if(void 0!==u)return u}this.setToken(h),this.handleLoading(!0,s,t);let v=await this.responseToResult(e);return l="function"==typeof l?l(i):l,"string"==typeof v?(this.showErrorMessage({result:v,message:d,description:l}),r&&r(v),v=a):(this.showSuccessMessage({result:v,message:d,description:l}),void 0===v&&(v=a),n&&this.storage.save(n.name,v),o&&o(v)),this.handleLoading(!1,s,t),v},this.request=async t=>{let{url:i,body:s,description:r,message:o,loading:a,loadingParent:n,token:d,onError:l,onSuccess:h,errorResult:u,cache:v,parameter:f}=t,g=t.onCatch||e.onCatch,p=t.getError||e.getError,c;return await this.requestFn({parameter:f,config:{description:r,message:o,loading:a,loadingParent:n,token:d,onError:l,onSuccess:h,onCatch:g,getError:p,errorResult:u,cache:v},method:t.method?t.method:"post",body:s,url:i,getResult:"function"==typeof t.getResult?t.getResult:()=>{}})}}}exports.default=AIOApis;class Storage{constructor(e){_defineProperty(this,"model",void 0),_defineProperty(this,"time",void 0),_defineProperty(this,"init",void 0),_defineProperty(this,"saveStorage",void 0),_defineProperty(this,"getParent",void 0),_defineProperty(this,"removeValueByField",void 0),_defineProperty(this,"setValueByField",void 0),_defineProperty(this,"getValueByField",void 0),_defineProperty(this,"save",void 0),_defineProperty(this,"remove",void 0),_defineProperty(this,"load",void 0),_defineProperty(this,"clear",void 0),_defineProperty(this,"download",void 0),_defineProperty(this,"export",void 0),_defineProperty(this,"read",void 0),_defineProperty(this,"import",void 0),_defineProperty(this,"getModel",void 0),this.model={},this.time={},this.init=()=>{let t=localStorage.getItem("storageClass"+e),i=localStorage.getItem("storageClassTime"+e),s,r;s=null==t?{}:JSON.parse(t),r=null==i?{}:JSON.parse(i),this.model=s,this.time=r,this.saveStorage(s,r)},this.saveStorage=(t,i)=>{localStorage.setItem("storageClass"+e,JSON.stringify(t)),localStorage.setItem("storageClassTime"+e,JSON.stringify(i))},this.getParent=e=>{let t=e.split("."),i=this.model;for(let s=0;s<t.length-1;s++)if("object"!=typeof(i=i[t[s]]))return;return i},this.removeValueByField=e=>{let t=e.split("."),i=this.getParent(e),s=t[t.length-1],r={};for(let o in i)o!==s&&(r[o]=i[o]);return t.pop(),this.setValueByField(t.join("."),r)},this.setValueByField=(e,t)=>{if(!e){this.model=t;return}var i=e.split("."),s=this.model;for(let r=0;r<i.length-1;r++){let o=i[r];void 0===s[o]&&(s[o]={}),s=s[o]}return s[i[i.length-1]]=t,this.getValueByField(i[0])},this.getValueByField=e=>{let t=e.split("."),i={...this.model};for(let s=0;s<t.length-1;s++)if("object"!=typeof(i=i[t[s]]))return;return i[t[t.length-1]]},this.save=(e,t)=>{try{t=JSON.parse(JSON.stringify(t))}catch{}if(!e||null===e)return{};let i=this.setValueByField(e,t);return this.time[e]=new Date().getTime(),this.saveStorage(this.model,this.time),i},this.remove=(e,t=()=>{})=>{let i=this.removeValueByField(e),s={};for(let r in this.time)r!==e&&(s[r]=this.time[r]);return this.time=s,this.saveStorage(this.model,this.time),t(),i},this.load=(e,t,i)=>{let s=this.getValueByField(e);if(i&&void 0!==s){let r=new Date().getTime(),o=this.time[e]||r;Math.abs(r-o)>i&&(s=void 0)}return void 0===s&&void 0!==t&&(s="function"==typeof t?t():t,this.save(e,t)),s},this.clear=()=>{this.model={},this.time={},this.saveStorage(this.model,this.time)},this.download=(e,t)=>{if(!t||null===t)return;let i=JSON.stringify(e),s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(i)),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},this.export=()=>{let e=window.prompt("Please Inter File Name");null!==e&&e&&this.download({model:this.model,time:this.time},e)},this.read=(e,t=()=>{})=>{var i=new FileReader;i.onload=()=>{try{t(JSON.parse(i.result))}catch{return}},i.readAsText(e)},this.import=(e,t=()=>{})=>{this.read(e,e=>{if(void 0===e)return;let{model:i,time:s}=e;this.model=i,this.time=s,this.saveStorage(this.model,this.time),t()})},this.getModel=()=>JSON.parse(JSON.stringify(this.model)),this.init()}}