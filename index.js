function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}import e from"axios";import t from"../aio-popup";import i from"../aio-loading";export default class r{constructor(r){_defineProperty(this,"props",void 0),_defineProperty(this,"storage",void 0),_defineProperty(this,"aioLoading",void 0),_defineProperty(this,"popup",void 0),_defineProperty(this,"setToken",t=>{let i=t||this.props.token;i&&(e.defaults.headers.common.Authorization=`Bearer ${i}`)}),_defineProperty(this,"addAlert",e=>{let{type:t,text:i,subtext:r,time:s,alertType:o="alert"}=e;"alert"===o?this.popup.addAlert({type:t,text:i,subtext:r,time:s,className:"aio-apis-popup"}):this.popup.addSnackebar({type:t,text:i,subtext:r,time:s})}),_defineProperty(this,"renderPopup",()=>this.popup.render()),_defineProperty(this,"setStorage",(e,t)=>this.storage.save(e,t)),_defineProperty(this,"getStorage",(e,t)=>this.storage.load(e,t)),_defineProperty(this,"removeStorage",e=>this.storage.remove(e)),_defineProperty(this,"handleCacheVersions",e=>{let t={};for(let i in e)t[i]=0;let r=this.getStorage("storedCacheVersions",t),s={};for(let o in e)void 0!==r[o]&&(r[o]!==e[o]?(s[o]=!0,this.removeStorage(o)):s[o]=!1);return this.setStorage("storedCacheVersions",e),s}),_defineProperty(this,"showErrorMessage",e=>{let{result:t,message:i,description:r}=e;if(!1===i.error)return;let s;s="string"==typeof i.error?i.error:"fa"===this.props.lang?`${r} با خطا روبرو شد`:`An error was occured in ${r}`,this.addAlert({type:"error",text:s,subtext:t,time:i.time,alertType:i.type})}),_defineProperty(this,"showSuccessMessage",e=>{let{result:t,message:i,description:r}=e;if(!i.success)return;let s="function"==typeof i.success?i.success(t):i.success;!0===s&&(s=""),this.addAlert({type:"success",text:"fa"===this.props.lang?`${r} با موفقیت انجام شد`:`${r} was successfull`,subtext:s,time:i.time,alertType:i.type})}),_defineProperty(this,"responseToResult",async t=>{let{url:i,method:r,body:s,getResult:o,config:a={},headers:n}=t,{onCatch:h=this.props.onCatch,getError:l=this.props.getError}=a;try{let d=await e({method:r,url:i,data:s,headers:n});if(d){let p=l?l(d,a):void 0;if("string"==typeof p)return p}return o(d)}catch(u){let f=l?l(u.response||u,a):void 0;if(f)return f;let g;try{g=h?h(u,a):void 0}catch(y){g=y.message||y.Message}return g||(g=u.message||u.Message),g}}),_defineProperty(this,"requestFn",async e=>{let{config:t={},parameter:i}=e,r="aa"+Math.round(1e5*Math.random()),{onError:s,onSuccess:o,errorResult:a,cache:n,message:h={},description:l=r,token:d}=t;if(n){let p=this.storage.load(n.name,void 0,n.time);if(void 0!==p)return p}this.setToken(d),t.loading&&this.aioLoading.show(r,t.loadingParent);let u=await this.responseToResult(e);return l="function"==typeof l?l(i):l,"string"==typeof u?(this.showErrorMessage({result:u,message:h,description:l}),s&&s(u),u=a):(this.showSuccessMessage({result:u,message:h,description:l}),void 0===u&&(u=a),n&&this.storage.save(n.name,u),o&&o(u)),t.loading&&this.aioLoading.hide(r),u}),_defineProperty(this,"request",async e=>{let{url:t,body:i,description:r,message:s,loading:o,headers:a,loadingParent:n,token:h,onError:l,onSuccess:d,errorResult:p,cache:u,parameter:f}=e,g=e.onCatch||this.props.onCatch,y=e.getError||this.props.getError,m;return await this.requestFn({parameter:f,config:{description:r,message:s,loading:o,loadingParent:n,token:h,onError:l,onSuccess:d,onCatch:g,getError:y,errorResult:p,cache:u},method:e.method?e.method:"post",body:i,url:t,getResult:"function"==typeof e.getResult?e.getResult:()=>{},headers:a})});let{id:s,getAppState:o=()=>{},loader:a,lang:n="en"}=r;this.props={id:s,getAppState:o,loader:a,lang:n},this.aioLoading=new i(a),this.storage=new Storage(s),this.popup=new t}};class Storage{constructor(e){_defineProperty(this,"model",void 0),_defineProperty(this,"time",void 0),_defineProperty(this,"init",void 0),_defineProperty(this,"saveStorage",void 0),_defineProperty(this,"getParent",void 0),_defineProperty(this,"removeValueByField",void 0),_defineProperty(this,"setValueByField",void 0),_defineProperty(this,"getValueByField",void 0),_defineProperty(this,"save",void 0),_defineProperty(this,"remove",void 0),_defineProperty(this,"load",void 0),_defineProperty(this,"clear",void 0),_defineProperty(this,"getModel",void 0),this.model={},this.time={},this.init=()=>{let t=localStorage.getItem("storageClass"+e),i=localStorage.getItem("storageClassTime"+e),r,s;r=null==t?{}:JSON.parse(t),s=null==i?{}:JSON.parse(i),this.model=r,this.time=s,this.saveStorage(r,s)},this.saveStorage=(t,i)=>{localStorage.setItem("storageClass"+e,JSON.stringify(t)),localStorage.setItem("storageClassTime"+e,JSON.stringify(i))},this.getParent=e=>{let t=e.split("."),i=this.model;for(let r=0;r<t.length-1;r++)if("object"!=typeof(i=i[t[r]]))return;return i},this.removeValueByField=e=>{let t=e.split("."),i=this.getParent(e),r=t[t.length-1],s={};for(let o in i)o!==r&&(s[o]=i[o]);return t.pop(),this.setValueByField(t.join("."),s)},this.setValueByField=(e,t)=>{if(!e){this.model=t;return}var i=e.split("."),r=this.model;for(let s=0;s<i.length-1;s++){let o=i[s];void 0===r[o]&&(r[o]={}),r=r[o]}return r[i[i.length-1]]=t,this.getValueByField(i[0])},this.getValueByField=e=>{let t=e.split("."),i={...this.model};for(let r=0;r<t.length-1;r++)if("object"!=typeof(i=i[t[r]]))return;return i[t[t.length-1]]},this.save=(e,t)=>{try{t=JSON.parse(JSON.stringify(t))}catch{}if(!e||null===e)return{};let i=this.setValueByField(e,t);return this.time[e]=new Date().getTime(),this.saveStorage(this.model,this.time),i},this.remove=(e,t=()=>{})=>{let i=this.removeValueByField(e),r={};for(let s in this.time)s!==e&&(r[s]=this.time[s]);return this.time=r,this.saveStorage(this.model,this.time),t(),i},this.load=(e,t,i)=>{let r=this.getValueByField(e);if(i&&void 0!==r){let s=new Date().getTime(),o=this.time[e]||s;Math.abs(s-o)>i&&(r=void 0)}return void 0===r&&void 0!==t&&(r="function"==typeof t?t():t,this.save(e,t)),r},this.clear=()=>{this.model={},this.time={},this.saveStorage(this.model,this.time)},this.getModel=()=>JSON.parse(JSON.stringify(this.model)),this.init()}}